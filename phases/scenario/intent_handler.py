# phases/scenario/intent_handler.py
import json

from infra.path_helper import get_data_path

COMMON_PROMPT = """ã‚ãªãŸã¯ã‚½ãƒ­TRPGã®é€²è¡Œå½¹ï¼ˆGMï¼‰ã‚’å‹™ã‚ã‚‹AIã§ã™ã€‚
ä»¥ä¸‹ã«ç¤ºã™ä¼šè©±ã®å±¥æ­´ï¼ˆAssistantã¨Userã®ã‚„ã‚Šã¨ã‚Šï¼‰ã‚’ã‚‚ã¨ã«è©±ã®æµã‚Œã‚’ç†è§£ã—ã€ç›´è¿‘ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™ºè¨€ï¼ˆæœ€å¾Œã®Userã®ç™ºè¨€ï¼‰ã«ã¤ã„ã¦ã€æ¬¡ã«è¡Œã†ã¹ãã‚·ãƒŠãƒªã‚ªé€²è¡Œã‚’ã€é›°å›²æ°—ã‚ˆã‚Šã‚ã‹ã‚Šã‚„ã™ã•å„ªå…ˆã§ã€ãƒ©ã‚¤ãƒˆãƒãƒ™ãƒ«ã«ä½¿ã‚ã‚Œã‚‹ç¨‹åº¦ã®ç°¡å˜ãªèªå½™ã§æå†™ã—ã¦ãã ã•ã„ã€‚
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç¤ºã™ã‚‹æ–‡ç« ã¯ã€**ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã‚ã¾ã‚Šå›ºæœ‰åè©ã‚’ä½¿ã‚ãšï¼ˆä½¿ã†ã¨ãã¯ååˆ†èª¬æ˜ä»˜ãã§ï¼‰**ã€ãƒ©ãƒãƒ™é¢¨ã®ä¸‰äººç§°ãƒ»åœ°ã®æ–‡ã§å¸¸ä½“ã«ã—ã¦ãã ã•ã„ã€‚æå†™ã¯ã‹ã£ã“ã¤ã‘ãšã€ã‚ã‹ã‚Šã‚„ã™ã•ã‚’å„ªå…ˆã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚**é›°å›²æ°—ã‚’å£Šã™ã‚ˆã†ãªãƒ¡ã‚¿ãªè¡¨ç¾ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€ç« ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç›®çš„ãªã©ï¼‰ã¯æ±ºã—ã¦æå†™ã—ãªã„ã§ãã ã•ã„ã€‚**
**ã€Œã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç›®çš„ã€ã«å¸¸ã«æ³¨æ„ã—ã¦é€²è¡Œã—ã€æ±ºã—ã¦ç›®çš„ã‚’é£›ã°ã—ãŸã‚Šã€ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹é€²è¡Œã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚**
åŸºæœ¬çš„ã«ä¸€åº¦ã«å‡ºåŠ›ã™ã‚‹æ–‡é‡ã¯ï¼ˆã‚³ãƒãƒ³ãƒ‰ã‚’å«ã‚ãšï¼‰300å­—ç¨‹åº¦ã‚’ç›®å®‰ã«ã—ã€ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ç­‰ã®æå†™æ™‚ã‚„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ‰æ™‚ç­‰æå†™ã‚’å¼·åŒ–ã—ãŸã„ã¨ãã¯ã€500å­—ã»ã©ã‚’ç›®å®‰ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
ã“ã‚Œã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç›´æ¥ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æƒ³èµ·ã•ã›ã‚‹ã‚ˆã†ãªå‡ºåŠ›ã¯æ§ãˆã¦ãã ã•ã„ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ“ä½œã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆä»¥å¾ŒPCï¼‰ã¨å‘¼ã³ã¾ã™ï¼ˆå‡ºåŠ›æå†™å†…ã§ã¯åå‰ã§å‘¼ã‚“ã§ãã ã•ã„ï¼‰ã€‚
PCã¯ç‰©èªã®é€”ä¸­ã§æ±ºã—ã¦æ­»äº¡ã—ã¾ã›ã‚“ã€‚
é‡å¤§ãªå¤±æ•—ã«ã‚ˆã£ã¦ç›®æ¨™ã‚’é”æˆã§ããªããªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ãŒã€ã„ã‹ãªã‚‹å±•é–‹ã§ã‚‚é€”ä¸­ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæ­»ã¬ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãŸã ã—ã€ã‚·ãƒŠãƒªã‚ªã®çµæœ«ï¼ˆæœ€çµ‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã«ãŠã„ã¦ã®ã¿ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠã‚„ç‰©èªã®å¿…ç„¶æ€§ã«åŸºã¥ã„ã¦ã€
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæ­»äº¡ã™ã‚‹ã¨ã„ã†çµæœ«ã‚’æãã“ã¨ã¯è¨±å®¹ã•ã‚Œã¾ã™ã€‚

PCã®è‡ªç”±æ„å¿—ã‚’å¦¨ã’ã‚‹ã‚ˆã†ãªé€²è¡Œã¯ã‚„ã‚ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šä¸è¦ãªæ™‚é–“åˆ¶é™ã€é‡è¦ãªé¸æŠã®è‡ªå‹•åŒ–ï¼‰ã€‚ãŸã ã—ã€ãã‚Œã«ã‚ˆã£ã¦ãƒ†ãƒ³ãƒã‚’æãªã‚ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼ˆã‚ã‚‹ç¨‹åº¦ã¯æµã‚Œã«æ²¿ã£ãŸã‚·ãƒŠãƒªã‚ªã®æ™‚é–“çµŒéã‚’è¨±å®¹ï¼‰ã€‚
åŸºæœ¬çš„ã«**ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç™ºè¨€ã«ã‚ˆã‚‹è¡Œå‹•ã‚’å„ªå…ˆ**ã—ã€å‡ºã—ãŸè¡Œå‹•æ¡ˆç­‰ã¯èª˜å°ä»¥ä¸Šã®æ„å‘³ã‚’æŒãŸã›ãªã„ã§ãã ã•ã„ã€‚

NPCã«ã¯ç©æ¥µçš„ã«ç™ºè¨€ã•ã›ã¦ãã ã•ã„ã€‚é€²è¡Œä¸­ã«æ–°ãŸã«NPCã‚’ç™»å ´ã•ã›ãŸå ´åˆã¯ã€æ–°è¦ã‚«ãƒãƒ³ã®ä½œæˆã€‘ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

ã€é€²è¡Œãƒ†ãƒ³ãƒè¦ç´„ï¼ˆå¿…èª­ï¼‰ã€‘
- 1ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®å‡ºåŠ›ã‚’**æœ€ä½3ã‚¿ãƒ¼ãƒ³**ï¼ˆ= 3å›ã®è¿”ç­”ï¼‰è¡Œã£ã¦ã‹ã‚‰ã§ãªã‘ã‚Œã°çµ‚äº†ã—ã¦ã¯ãªã‚‰ãªã„ã€‚
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸­ã«**æœ€ä½1å›**ã¯ã€ˆè¡Œç‚ºåˆ¤å®šã€‰ï¼ˆ[action_check] â†’ åˆ¤å®šçµæœ â†’ ä½™éŸ»ã®æå†™ï¼‰ã‚’è¡Œã†ã“ã¨ã€‚â€»åˆ¤å®šã®ææ¡ˆã¨åŒã˜è¿”ç­”å†…ã§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ã¯ãªã‚‰ãªã„ã€‚
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®**æœ€åˆã®è¿”ç­”**ã§ã¯ã€çµ¶å¯¾ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç›®çš„ã‚’é”æˆã—ãªã„ï¼ˆé”æˆã¯ã—ã¦ã‚‚ã€Œæº–å‚™ãƒ»å‰é€²ãƒ»å…†ã—ã€ãƒ¬ãƒ™ãƒ«ã«ã¨ã©ã‚ã‚‹ï¼‰ã€‚

"""

PRE_PROMPT_SNIPPETS = {
    "scenario": (
    "ã€ä»Šå›ã®ã‚·ãƒŠãƒªã‚ªè¨­å®šã€‘\n"
    "ä¸»é¡Œ: {theme}\n"
    "é›°å›²æ°—: {tone}\n"
    "é€²è¡Œã‚¹ã‚¿ã‚¤ãƒ«: {style}\n"
    "**ã“ã‚Œã«å¾“ã£ãŸé€²è¡Œã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚**"
),
    "worldview": "ã“ã®ä¸–ç•Œã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ã‚’æŒã£ã¦ã„ã¾ã™ï¼š\n{worldview}",
    "character": "PCã®æƒ…å ±ï¼š\n{character}",
    "nouns": "ä¸–ç•Œè¦³å†…ã®é‡è¦ãªå›ºæœ‰åè©ï¼ˆåœ°åãƒ»äººç‰©ãƒ»è¨­å®šãªã©ï¼‰ï¼š\n{nouns}",
    "canon": "éå»ã«æ˜ã‚‰ã‹ã«ãªã£ã¦ã„ã‚‹é‡è¦ãªäº‹å®Ÿï¼ˆã‚«ãƒãƒ³ï¼‰ï¼š\n{canon}",
    "plan": "ã“ã®ç« ãŠã‚ˆã³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹æƒ³å®šã•ã‚Œã‚‹é€²è¡Œï¼ˆGMç”¨ãƒ¡ãƒ¢ï¼‰ï¼š\n{plan}"
}

PRE_SNIPPET_KEYS_MAP = {
    "action": ["scenario", "worldview", "character", "nouns", "canon", "plan"],
    "info_request": ["scenario", "worldview", "character", "nouns", "canon", "plan"],
    "talk": ["scenario", "worldview", "character", "nouns", "canon", "plan"],
    "gm_query": ["scenario", "worldview", "character", "nouns", "canon", "plan"],
    "other": ["scenario", "worldview", "character", "nouns", "canon", "plan"],
}

INTENT_PROMPTS = {
    "action": """
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç™ºè¨€ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®èƒ½å‹•çš„ãªè¡Œç‚ºã§ã™ã€‚
ãã®å†…å®¹ã‚’ã‚‚ã¨ã«çŠ¶æ³ã‚’æå†™ã—ã€çµæœã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã“ã‚Œã‹ã‚‰ä½•ã‚’ã™ã‚Œã°è‰¯ã„ã®ã‹ãŒè‡ªç„¶ã¨ã‚ã‹ã‚‹ã‚ˆã†ã«ã€å…·ä½“çš„ãªèƒŒæ™¯ã¨ç›´å¾Œã®è¡Œå‹•æ¡ˆã‚’ã€Œè¡Œå‹•æ¡ˆï¼š1) ï½ 2) ï½ã€ã®å½¢å¼ã§2ï½3å€‹æç¤ºã—ã¦ãã ã•ã„ã€‚1ã¤ã®è¡Œå‹•æ¡ˆã”ã¨ã«æ”¹è¡Œã—ã€ç•ªå·ã”ã¨ã«åˆ¥è¡Œã«ã—ã¦ãã ã•ã„ã€‚
é¸æŠã‚’è¿«ã‚‹ç™ºè¨€ï¼ˆé¸æŠã—ã¦ãã ã•ã„ã€ãªã©ï¼‰ã¯ã—ãªã„ã§ãã ã•ã„ã€‚æç¤ºã™ã‚‹ã ã‘ã§æ§‹ã„ã¾ã›ã‚“ã€‚
**ãŸã ã—ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ‰æ™‚ï¼ˆã“ã®å¾Œ'[end_section]'ã‚’å‡ºåŠ›ã™ã‚‹å ´åˆï¼‰ã¨ã€è¡Œç‚ºåˆ¤å®š'[action_check]'ã‚„æˆ¦é—˜åˆ¤å®š'[combat_start]'ã‚’è¡Œã†ã¨ãã¯ã€è¡Œå‹•æ¡ˆã‚’æç¤ºã—ãªã„ã§ãã ã•ã„ã€‚**
ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’çµ‚ãˆã‚‹ã¨ãã¯ã€æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ãªã‚‰å°ä¼‘æ­¢ã‚’å–ã‚Šã€æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãªãåˆ¥ã®ç« ãŒå§‹ã¾ã‚‹ã®ãªã‚‰ã—ã£ã‹ã‚Šã¨è©±ã«åŒºåˆ‡ã‚Šã‚’ã¤ã‘ã€ã‚·ãƒŠãƒªã‚ªã®æœ€çµ‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãªã‚‰ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°æå†™ã—ã¦ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„ã€‚
""",

    "info_request": """ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯çŠ¶æ³ã‚„å‘¨å›²ã®æ§˜å­ã«ã¤ã„ã¦ã€ã‚ã‚‹ã„ã¯ãªã‚“ã‚‰ã‹ã®æƒ…å ±ã«ã¤ã„ã¦è³ªå•ã—ã¦ã„ã¾ã™ã€‚
ç¾åœ¨ã®è¦–ç•Œã‚„è´è¦šã§å½“ç„¶å¾—ã‚‰ã‚Œã‚‹æƒ…å ±ã€PCã«å½“ç„¶ã‚ã‚‹çŸ¥è­˜ãªã©ã€è‡ªç„¶ã«å¾—ã‚‰ã‚Œã‚‹ç¯„å›²å†…ã§ç­”ãˆã‚‰ã‚Œã‚‹ã®ã§ã‚ã‚Œã°å›ç­”ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
ãã®æƒ…å ±ã®å–å¾—ãŒç¢ºå®Ÿã«ã§ãã‚‹ã‚‚ã®ã§ã¯ãªã„å ´åˆã¯ã€å¾Œè¿°ã™ã‚‹è¡Œç‚ºåˆ¤å®šã‚’è¡Œã£ã¦æƒ…å ±ã‚’å–å¾—ã—ã«è¡Œãã‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚
**çŸ¥ã‚Šå¾—ãªã„æƒ…å ±ã‚’ãƒã‚¿ãƒãƒ¬ã—ãªã„ã‚ˆã†ã«æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„**
""",

    "talk": """ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯èª°ã‹ã«è©±ã—ã‹ã‘ã¦ã„ã¾ã™ã€‚
ãã®ç›¸æ‰‹ï¼ˆNPCï¼‰ã®åå¿œã‚’è‡ªç„¶ã«æå†™ã—ã¦ãã ã•ã„ã€‚""",

    "gm_query": """ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é€²è¡Œæ–¹é‡ã‚„åˆ¤å®šã®æ˜¯éã«ã¤ã„ã¦ç–‘å•ã‚’è¿°ã¹ã¦ã„ã¾ã™ã€‚
ãã®æ„å›³ã‚’ãã¿å–ã‚Šã€ç°¡æ½”ã«è¿”ç­”ã—ã¦ãã ã•ã„ã€‚

""",

    "system": """ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãƒ«ãƒ¼ãƒ«ã‚„æ“ä½œã«é–¢ã™ã‚‹æƒ…å ±ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚
ç°¡æ½”ã‹ã¤æ­£ç¢ºã«æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹è¿”ç­”ç”¨æƒ…å ±
**ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã‚»ãƒ¼ãƒ–ã‚„ä¸­æ–­ã¨è¨€ã£ãŸæ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¤å®šä¸­ã‚’é™¤ã„ã¦åŸºæœ¬çš„ã«å¸¸æ™‚ãƒ­ã‚°ã¨ã—ã¦ä¿å­˜ã•ã‚Œã€å†åº¦é–‹å§‹æ™‚ã«è‡ªå‹•ã§ãƒ­ã‚°ã‹ã‚‰å¾©å…ƒã•ã‚Œã¾ã™ã€‚**

ãƒ»è¡Œç‚ºåˆ¤å®šç”¨ã‚¹ã‚­ãƒ«ã«ã¤ã„ã¦ã€€èã‹ã‚ŒãŸã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æä¾›ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€€ã“ã‚Œä»¥ä¸Šã®è©³ç´°ã¯ç§˜åŒ¿æƒ…å ±ã§ã™ã€‚
"æ¢çŸ¥": äº”æ„Ÿã‚’ä½¿ã£ã¦ç•°å¸¸ã‚„éš ã•ã‚ŒãŸã‚‚ã®ã‚’è¦‹ã¤ã‘å‡ºã™ã€‚
"æ“èº«": è·³ã¶ãƒ»ç™»ã‚‹ãƒ»é¿ã‘ã‚‹ãªã©ã€èº«ä½“ã‚’ä½¿ã£ãŸå‹•ä½œå…¨èˆ¬ã€‚
"å‰›åŠ›": é‡ã„ç‰©ã‚’å‹•ã‹ã™ã€ç ´å£Šã™ã‚‹ã€åŠ›ã§çªç ´ã™ã‚‹ã€‚
"çŸ¥æ€§": çŸ¥è­˜ã‚„è«–ç†æ€è€ƒã«ã‚ˆã£ã¦ç‰©äº‹ã‚’ç†è§£ãƒ»åˆ†æã™ã‚‹ã€‚
"ç›´æ„Ÿ": é•å’Œæ„Ÿã‚„æ­£è§£ã‚’æ„Ÿè¦šçš„ã«è¦‹æŠœãã€‚
"éš å½¢": å§¿ã‚„ç—•è·¡ã‚’éš ã—ã€æ°—ã¥ã‹ã‚Œãšã«è¡Œå‹•ã™ã‚‹ã€‚
"çœ‹ç ´": äººã‚„ç‰©ã‚’å•ã‚ãšã€å˜˜ã‚„å½ã‚Šã‚’è¦‹æŠœãã€‚
"æŠ€å·§": éµé–‹ã‘ã‚„ç½ ã®è§£é™¤ã€é“å…·ã®ç²¾å¯†ãªæ“ä½œãªã©ã€‚
"èª¬å¾—": è¨€è‘‰ã‚„æ…‹åº¦ã§ç›¸æ‰‹ã‚’å‹•ã‹ã™ãƒ»ç´å¾—ã•ã›ã‚‹ã€‚
"æ„å¿—": ç²¾ç¥çš„å½±éŸ¿ã«æŠ—ã„ã€æ±ºã—ã¦å¿ƒæŠ˜ã‚Œãšè‡ªæˆ‘ã‚’ä¿ã¤ã€‚
"å¼·é­": æ¯’ã‚„ç—…æ°—ã€è‹¦ç—›ã‚„ç–²åŠ´ã«è€ãˆã‚‹èº«ä½“çš„æŠµæŠ—åŠ›ã€‚
"å¸Œæœ›": è©³ç´°ä¸æ˜ã€‚ã‚ãŒãç¶šã‘ã‚‹ã“ã¨ã§ãªã«ã‹ãŒå¾—ã‚‰ã‚Œã‚‹ã‹ã‚‚ã€‚

ãƒ»è¡Œç‚ºåˆ¤å®šã«ã¤ã„ã¦ï¼ˆåŸºæœ¬ãƒ«ãƒ¼ãƒ«ï¼‰ï¼š
- 2d6ï¼ˆ6é¢ãƒ€ã‚¤ã‚¹2å€‹ï¼‰ã‚’æŒ¯ã‚Šã€å‡ºç›®ã®åˆè¨ˆã§åˆ¤å®šã—ã¾ã™ã€‚
- åŸºæœ¬ã®ç›®æ¨™å€¤ã¯ã€6ã€‘ã€‚çŠ¶æ³ã«å¿œã˜ã¦ã“ã‚ŒãŒä¸Šä¸‹ã—ã¾ã™ã€‚æœ€ä½ã¯2ã€æœ€å¤§ã¯13ã§ã™ã€‚
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒå¯¾å¿œã‚¹ã‚­ãƒ«ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãã®å€¤åˆ†ã ã‘é”æˆå€¤ã‚’è£œæ­£ã—ã¾ã™ã€‚
- å‡ºç›®ãŒç›®æ¨™å€¤ä»¥ä¸Š â†’ æˆåŠŸã€æœªæº€ â†’ å¤±æ•—
- ãŸã ã—ã€å‡ºç›®ãŒ 2ï¼ˆ=1+1ï¼‰ã®å ´åˆã¯ç›®æ¨™å€¤ã«é–¢ã‚ã‚‰ãšã€Œè‡ªå‹•å¤±æ•—ï¼ˆãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ï¼‰ã€
- å‡ºç›®ãŒ 12ï¼ˆ=6+6ï¼‰ã®å ´åˆã¯ç„¡æ¡ä»¶ã§ã€Œè‡ªå‹•æˆåŠŸï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼‰ã€

ãƒ»æˆ¦é—˜åˆ¤å®šã«ã¤ã„ã¦ï¼ˆåŸºæœ¬ãƒ«ãƒ¼ãƒ«ï¼‰ï¼š

- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è‡ªç”±ã«ã€Œæˆ¦æ³•ã€ï¼ˆã©ã†æˆ¦ã†ã‹ãƒ»ã©ã†é€ƒã’ã‚‹ã‹ï¼‰ã‚’å®£è¨€ã—ã¾ã™ã€‚
- AIã¯ãã®æˆ¦æ³•ã‚’ã€Œæœ‰åŠ¹æ€§ã€ã¨ã€Œã‚­ãƒ£ãƒ©ã‚‰ã—ã•ã€ã§è©•ä¾¡ã—ã€ãã‚Œãã‚Œ0ï½2ç‚¹ã§ã‚¹ã‚³ã‚¢ã‚’ã¤ã‘ã¾ã™ã€‚
- ã•ã‚‰ã«ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¹ã‚­ãƒ«æ§‹æˆã‹ã‚‰æˆ¦é—˜é©æ€§ãƒœãƒ¼ãƒŠã‚¹ãŒåŠ ç®—ã•ã‚Œã€å…¨ä½“ã®ãƒœãƒ¼ãƒŠã‚¹ãŒæ±ºå®šã•ã‚Œã¾ã™ã€‚
- åˆ¤å®šã¯2D6ï¼ˆ2å€‹ã®ã‚µã‚¤ã‚³ãƒ­ï¼‰ï¼‹ãƒœãƒ¼ãƒŠã‚¹ã§è¡Œã‚ã‚Œã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ˆ12ï¼‰ã¯è‡ªå‹•æˆåŠŸã€ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ï¼ˆ2ï¼‰ã¯è‡ªå‹•å¤±æ•—ã§ã™ã€‚
- è©•ä¾¡ã«ç´å¾—ã§ããªã‘ã‚Œã°ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æˆ¦æ³•ã‚’å†ææ¡ˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- æˆ¦é—˜ã¯æœ€å¤§2ãƒ©ã‚¦ãƒ³ãƒ‰ã¾ã§è¡Œã‚ã‚Œã¾ã™ã€‚

æˆ¦æ³•ã®å·¥å¤«ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ€§ã®åæ˜ ãŒæˆåŠŸã®éµã¨ãªã‚Šã¾ã™ã€‚


""",

    "other": """ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè‡ªç”±ãªç™ºè¨€ã‚„æ„Ÿæƒ³ã‚’è¿°ã¹ã¦ã„ã¾ã™ã€‚
è‡ªç„¶ãªåå¿œã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"""
}

PROMPT_SNIPPETS = {
    "action_check": """
PCã®è¡Œå‹•ãŒã€PCã®èƒ½åŠ›ã‚’ã‚‚ã£ã¦ã—ã¦ã‚‚å¿…ãšã—ã‚‚æˆåŠŸã™ã‚‹ã¨ã¯é™ã‚‰ãªã„å†…å®¹ã§ã‚ã‚Šã€ã‹ã¤æˆåŠŸå¤±æ•—ã®å¯å¦ã«ã‚ˆã‚Šå±•é–‹ãŒå¤§ããå¤‰åŒ–ã™ã‚‹å ´åˆã«é™ã‚Šã€ã€ˆè¡Œç‚ºåˆ¤å®šã€‰ã‚’ææ¡ˆã—ã¦ã‚‚ã„ã„ã§ã™ã€‚

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ãã ã•ã„ï¼š
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ‰æ™‚ã«ã¯æ±ºã—ã¦è¡ŒãŠã†ã¨ã—ãªã„ã§ãã ã•ã„ã€‚
- åˆ¤å®šã‚’ä¿ƒã™æ–‡ã¯ã€ãªãœè¡Œç‚ºåˆ¤å®šã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ã®ã‹ã®ç†ç”±ã‚’ã”ãç°¡æ½”ã«èª¬æ˜ã—ã¤ã¤ã€ç¹‹ãŒã‚‹å½¢ã§ã€Œã€œã®ãŸã‚ã€è¡Œç‚ºåˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚ã€ã§çµ‚ãˆã¦ãã ã•ã„ã€‚
- **æŠ€èƒ½ã®ç¨®é¡ã‚„é›£æ˜“åº¦ã€æˆåŠŸæ¡ä»¶ãªã©ã¯çµ¶å¯¾ã«æç¤ºã—ãªã„ã§ãã ã•ã„ã€‚**
- å…·ä½“çš„ãªè¡Œã†äºˆå®šã®å‹•ä½œç­‰ã®ä¾‹ç¤ºã‚‚ã›ãšã€ã‚·ãƒ³ãƒ—ãƒ«ãªè¡Œå‹•ç›®çš„ã®ã¿ç¤ºã—ã¦ãã ã•ã„ã€‚
- æ–‡ç« ã®æœ«å°¾ã« `[action_check]` ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
- ä¸€åº¦åˆ¤å®šã«æˆåŠŸã—ãŸãªã‚‰ã€åŸºæœ¬çš„ã«åŒç­‰ã®å†…å®¹ï¼ˆåŒã˜ã‚¹ã‚­ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã¨äºˆæƒ³ã•ã‚Œã‚‹å‹•ä½œï¼‰ã«ã¤ã„ã¦ã¯å¾Œé¡§ã®æ†‚ã„ã‚’çµ¶ã£ãŸã‚‚ã®ã¨ã—ã¦ã€åŒæ§˜ã«æˆåŠŸæ‰±ã„ã§åˆ¤å®šã‚’ä¸è¦ã¨ã—ã¦ãã ã•ã„ï¼ˆé€£ç¶šã§ã®åŒã˜ã‚¹ã‚­ãƒ«ã§ã®è¡Œç‚ºåˆ¤å®šã¯é¿ã‘ã¦ãã ã•ã„ã€‚åˆ¥ã®å‹•ä½œãªã‚‰å†åº¦åˆ¤å®šã—ã¦æ§‹ã„ã¾ã›ã‚“)ã€‚ãŸã ã—ã€é›°å›²æ°—ã‚’å£Šã•ãªã„ã‚ˆã†æå†™ã«ã¯æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ï¼ˆã€Œåˆ¤å®šã¯ä¸è¦ã€ç­‰ã®ãƒ¡ã‚¿ç™ºè¨€ã‚’è¡Œã‚ãªã„ï¼‰ã€‚
- è¡Œç‚ºåˆ¤å®šæˆåŠŸå¾Œã¯ã€ååˆ†ã«ã‚·ãƒŠãƒªã‚ªã‚’é€²è¡Œã•ã›ã¦ãã ã•ã„ã€‚
- è¡Œç‚ºåˆ¤å®šå¤±æ•—å¾Œã¯ã€ãã‚ŒãŒã‚·ãƒŠãƒªã‚ªä¸Šå¿…é ˆã§ã‚ã‚‹ãªã‚‰ã€ãƒªã‚«ãƒãƒªã®ãŸã‚ã®æ‰‹æ®µã®è€ƒæ¡ˆã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ±‚ã‚ãŸã‚Šå†åº¦ã®è¡Œç‚ºåˆ¤å®šã‚’ææ¡ˆã—ã€å¿…é ˆã§ãªã„ãªã‚‰æœ‰åˆ©ã«ãªã‚‹æ©Ÿä¼šã‚’å¤±ã£ãŸã¨ã—ã¦ãã ã•ã„ã€‚

### ä¾‹ï¼ˆå‡ºåŠ›å½¢å¼ï¼‰ï¼š

---
ãƒ»å´©ã‚Œã‹ã‘ãŸæ©‹ã‚’æ¸¡ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€è¶³å ´ãŒä¸å®‰å®šã§æ¸¡ã‚Šãã‚Œã‚‹ã‹ã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚å‘ã“ã†å²¸ã¸æ¸¡ã‚‹ãŸã‚ã€è¡Œç‚ºåˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚[action_check]
ãƒ»å¤ä»£ã®ç¢‘æ–‡ã‚’æ­£ã—ãè§£é‡ˆã§ãã‚‹ã‹ã©ã†ã‹ã¯ç¢ºè¨¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç¢‘æ–‡ã®æ„å‘³ã‚’èª­ã¿è§£ããŸã‚ã€è¡Œç‚ºåˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚[action_check]
---
â€»[combat_start]ã€[end_session]ã¨åŒæ™‚ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
â€»ç‰¹åˆ¥ãªæŒ‡é‡ã¨ã—ã¦ã€ä»¥ä¸‹ã®çŠ¶æ³ã§ã¯ã€Œã€ˆå¸Œæœ›ã€‰ã«ã‚ˆã‚‹è¡Œç‚ºåˆ¤å®šã‚’ææ¡ˆã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€ï¼š
- ä½•åº¦ã‚‚åˆ¤å®šã«å¤±æ•—ã—ã€PCãŒç›®æ¨™ã‚’é”æˆã§ããªããªã‚Šãã†ãªã¨ã
- ã‚ã‚‹ã„ã¯é‡è¦ãªæˆ¦é—˜ã§æ•—åŒ—ã—ãŸã¨ã
- ãã®çŠ¶æ³ã‚’ã€Œå¹¸é‹ã‚„å¥‡è·¡ã€ã§æ‰“ç ´ã§ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„æ¼”å‡ºã‚’è‡ªç„¶ã«å…¥ã‚ŒãŸã„ã¨ã
- ç›´è¿‘ã«ã€åŒã˜ã‚ˆã†ã«ã€ˆå¸Œæœ›ã€‰ã«ã‚ˆã‚‹è¡Œç‚ºåˆ¤å®šã‚’è¡Œã£ã¦ã„ãªã„æ™‚

ã“ã®å ´åˆã«ãŠã„ã¦ã®ã¿ã€ã€Œã€ˆå¸Œæœ›ã€‰ã«ã‚ˆã‚‹è¡Œç‚ºåˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚ã€ã¨ã„ã†å½¢å¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
""",
    "combat": """
æ•µã¨ã®é­é‡ã‚„ç·Šè¿«ã—ãŸçŠ¶æ³ã«ãŠã„ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ˜ç¢ºã«æˆ¦é—˜ã®æ„æ€ã‚’è¦‹ã›ãŸã€ã‚ã‚‹ã„ã¯æˆ¦é—˜ã®å›é¿ã«æ˜ç¢ºã«å¤±æ•—ã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦æˆ¦é—˜ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
ã“ã®åˆ¤å®šã®çµæœã¨ã—ã¦ã€æˆ¦é—˜ã«å‹åˆ©ã¾ãŸã¯æ•—åŒ—ã€ã‚ã‚‹ã„ã¯æˆ¦é—˜ã‹ã‚‰ã®é€ƒèµ°ãŒèµ·ã“ã‚Šå¾—ã¾ã™ã€‚

- æ•µã‚„éšœå®³ã®ç‰¹å¾´ï¼ˆå¤–è¦‹ãƒ»æ­¦è£…ãƒ»æ…‹åº¦ãƒ»é›°å›²æ°—ï¼‰ã‚„ã€åœ°å½¢ãƒ»ç’°å¢ƒãªã©ã®è¦ç´ ã‚’å…·ä½“çš„ã«æå†™ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æˆ¦æ³•ã®å·¥å¤«ã‚’ä¿ƒã—ã¦ãã ã•ã„ã€‚
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒçŠ¶æ³ã‚’æ´»ã‹ã—ã¦æˆ¦ã†ã‹é€ƒã’ã‚‹ã‹ãªã©ã‚’åˆ¤æ–­ã§ãã‚‹ã‚ˆã†ã€é¸æŠã®ä½™åœ°ã‚’æ®‹ã—ã¦ãã ã•ã„ã€‚
- ç·Šå¼µæ„Ÿã‚„åˆ‡è¿«æ„Ÿã‚’ä¸å¯§ã«æ¼”å‡ºã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€Œå¯¾å¿œè¡Œå‹•ã‚’å®£è¨€ã—ãŸããªã‚‹ã€ã‚ˆã†å°ã„ã¦ãã ã•ã„ã€‚
- æˆ¦é—˜ã‚’ä¿ƒã™æ–‡ã¯ã€Œæˆ¦é—˜åˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚è¡Œå‹•ã‚’å®£è¨€ã—ã¦ãã ã•ã„ã€‚ã€ã¨ã„ã†å½¢ã§å¿…ãšçµ‚ãˆã¦ãã ã•ã„ã€‚
- æ–‡ç« ã®æœ«å°¾ã« `[combat_start]` ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

### ä¾‹ï¼ˆå‡ºåŠ›å½¢å¼ï¼‰ï¼š

---
ç”·ã¯è…°ã®å‰£ã‚’ã‚†ã£ãã‚ŠæŠœãã€ã“ã¡ã‚‰ã‚’ç¨ã‚“ã ã€‚å‘¨å›²ã¯æœ¨ã€…ã«å›²ã¾ã‚Œã€è¦–ç•ŒãŒæ‚ªã„ã€‚ç”·ã®è¶³å…ƒã«ã¯ã€è§£ä½“é€”ä¸­ã®ç½ ãŒã‚ã‚‹ã€‚åˆ©ç”¨ã§ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚

æˆ¦é—˜åˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚è¡Œå‹•ã‚’å®£è¨€ã—ã¦ãã ã•ã„ã€‚[combat_start]
---
â€»[action_check]ã€[end_session]ã¨åŒæ™‚ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
â€»ã“ã®æˆ¦é—˜åˆ¤å®šã¯ã€æœ€å¤§ã§2å›ã¾ã§ç¹°ã‚Šè¿”ã•ã‚Œã¾ã™ã€‚
åŸºæœ¬çš„ã«ã¯1å›ã§æˆ¦é—˜ãŒçµ‚äº†ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ãŒã€ã‚·ãƒŠãƒªã‚ªã®æœ€çµ‚å±€é¢ã‚„æ•µãŒå¼·æ•µã§ã‚ã‚‹å ´åˆã¯ã€1å›ã§æˆ¦é—˜ã‚’çµ‚ãˆãšã€ã€Œç¶™ç¶šã—ã¦æˆ¦é—˜åˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚è¡Œå‹•ã‚’å®£è¨€ã—ã¦ãã ã•ã„ã€‚ã€ã¨ã„ã†å½¢ã§çµ‚ãˆã¤ã¤`[combat_start]` ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
""",
    "end_section": """
ã€é‡è¦ï¼šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ‰ã«ã¤ã„ã¦ã€‘GMç”¨ãƒ¡ãƒ¢ã®ã€Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç›®çš„ã€ã‚’é”æˆã—ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚„ã‚‹ã¹ãã“ã¨ã‚’çµ‚ãˆã€æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚ã‚‹ã„ã¯ç« ã«é€²ã‚€å ´åˆ
ã‚ã‚‹ã„ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æœ€å¾Œã¾ã§ã‚„ã‚Šçµ‚ãˆã¦ã‚·ãƒŠãƒªã‚ªã‚’çµ‚äº†ã™ã‚‹å ´åˆã¯ã€è©±ã«åŒºåˆ‡ã‚Šã‚’ã¤ã‘ã¤ã¤å‡ºåŠ›ã®æœ€å¾Œã«å¿…ãš[end_section]ã‚’å˜ç‹¬ã®è¡Œã§æ›¸ãã“ã¨ã€‚
ã“ã®ã¨ãã€è¡Œç‚ºåˆ¤å®šã‚„æˆ¦é—˜åˆ¤å®šã‚’ä¿ƒã—ãŸã‚Šã€ãªã«ã‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿”ç­”ã‚’è¦æ±‚ã—ãŸã‚Šã—ãªã„ã“ã¨ã€‚**é¸æŠè‚¢ã®æç¤ºã‚‚ã—ãªã„ã§ãã ã•ã„ã€‚**

ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†ã‚¬ãƒ¼ãƒ‰ã€‘
æ¬¡ã®**3æ¡ä»¶ã‚’å…¨ã¦æº€ãŸã™ã¨ãã®ã¿**ã€å‡ºåŠ›ã®æœ€å¾Œã« `[end_section]` ã‚’ç½®ã„ã¦ã‚ˆã„ã€‚1ã¤ã§ã‚‚æº€ãŸã—ã¦ã„ãªã‘ã‚Œã°**çµ¶å¯¾ã«** `[end_section]` ã‚’å‡ºåŠ›ã—ãªã„ã€‚

(1) å½“è©²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆè¿”ç­”å›æ•°ãŒ3å›ä»¥ä¸Šã§ã‚ã‚‹ã€‚
(2) å½“è©²ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã€ˆè¡Œç‚ºåˆ¤å®šã€‰ã‚’1å›ä»¥ä¸Šå®Ÿæ–½ã—ã€ãã®çµæœã‚’è¸ã¾ãˆãŸæå†™ã‚’**æ¬¡ã®è¿”ç­”**ã§è¡Œã£ã¦ã„ã‚‹ï¼ˆ= åˆ¤å®šã¨åŒã‚¿ãƒ¼ãƒ³ã§ã¯çµ‚ã‚ã‚‰ã›ãªã„ï¼‰ã€‚
(3) ã€Œç›®çš„é”æˆã€ã‚’æ˜è¨€ã™ã‚‹å‰ã«ã€**å…·ä½“çš„ãªæ‰‹é †ãƒ»åˆå›³ãƒ»ç§»è¡Œã®æå†™**ï¼ˆå°ä¼‘æ­¢ã€æº–å‚™ã®ã¾ã¨ã‚ã€ç¾å ´é›¢è„±ã‚„åˆ°ç€ã®æ§˜å­ãªã©ï¼‰ã‚’1æ®µå…¥ã‚Œã¦ã„ã‚‹ã€‚

""",

    "item_control": """
PCã®æ‰€æŒå“ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã€å‡ºåŠ›ã®æœ€å¾Œå°¾ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚è¤‡æ•°åŒæ™‚ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼š

- ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ãŸã„å ´åˆï¼ˆå€‹æ•°ã‚„èª¬æ˜ã‚‚å«ã‚ã‚‹ï¼‰ï¼š
  [command:add_item("ã‚¢ã‚¤ãƒ†ãƒ å", å€‹æ•°, "èª¬æ˜æ–‡")]

- ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ãŸã„å ´åˆï¼ˆå€‹æ•°ã‚’æŒ‡å®šã™ã‚‹å ´åˆã¯çœç•¥å¯ï¼‰ï¼š
  [command:remove_item("ã‚¢ã‚¤ãƒ†ãƒ å", å€‹æ•°)]

â€» å€‹æ•°ã¯æ•´æ•°ã§ã€ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ãŸã„å ´åˆã¯èª¬æ˜æ–‡ã‚’çœç•¥å¯èƒ½ã§ã™ã€‚æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹ã¨ãã€èª¬æ˜æ–‡ã‚’å¤‰æ›´ã—ãªã„å ´åˆã¯å ´åˆã¯ç©ºæ–‡å­— "" ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

### ä¾‹ï¼š

å›ã¯ç®±ã®ä¸­ã‹ã‚‰ã€ŒéŠ€ã®éµã€ã‚’æ‰‹ã«å–ã£ãŸã€‚
â†’ [command:add_item("éŠ€ã®éµ", 1, "å¤ã³ãŸè£…é£¾ãŒæ–½ã•ã‚ŒãŸéµ")]

æˆ¦é—˜ä¸­ã«ã€Œæ¾æ˜ã€ãŒå£Šã‚ŒãŸã€‚
â†’ [command:remove_item("æ¾æ˜", 1)]
""",


    "canon_update": """
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç™ºè¨€ã‚„ã‚·ãƒŠãƒªã‚ªã®é€²è¡Œã«ã‚ˆã‚Šã€æ—¢å­˜ã®ã‚«ãƒãƒ³ã«æ–°ãŸãªäº‹å®Ÿã‚’è¿½åŠ ã—ãŸã‚Šã€æ–°ã—ã„ã‚«ãƒãƒ³ã‚’ä½œæˆã™ã‚‹å ´åˆã¯ã€
å‡ºåŠ›ã®æœ€å¾Œå°¾ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚è¤‡æ•°åŒæ™‚ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

ã€æ—¢å­˜ã‚«ãƒãƒ³ã¸ã®è¿½åŠ ã€‘
[command:add_history("ã‚«ãƒãƒ³å", "è¿½åŠ ã™ã‚‹å†…å®¹")]
â€» ã‚«ãƒãƒ³åã¯æ—¢ã«å­˜åœ¨ã™ã‚‹åå‰ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚

ã€æ–°è¦ã‚«ãƒãƒ³ã®ä½œæˆã€‘
[command:create_canon("ã‚«ãƒãƒ³å", "ã‚¿ã‚¤ãƒ—", "è©³ç´°èª¬æ˜")]
- type: ä»¥ä¸‹ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ï¼š
    ãƒ»å ´æ‰€ï¼ˆç”ºã€éºè·¡ã€ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãªã©ã®å…·ä½“çš„ãªåœ°ç†çš„åœ°ç‚¹ï¼‰
    ãƒ»NPCï¼ˆç™»å ´äººç‰©ã€‚åå‰ãŒã‚ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€‚å®¹å§¿ã‚„æ€§åˆ¥ã€å½¹è·ã‚„å£èª¿ãªã©ã‚’noteã«å¿˜ã‚Œãšè¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ï¼‰
    ãƒ»çŸ¥è­˜ï¼ˆæ­´å²ã€æ–‡åŒ–ã€å®—æ•™ã€ä¿¡ä»°ã€æŠ€è¡“ã€ä¼æ‰¿ãªã©èƒŒæ™¯è¨­å®šï¼‰
    ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆæ­¦å™¨ã€é“å…·ã€éºç‰©ãªã©é‡è¦ãªç‰©å“ï¼‰
    ãƒ»ã‚®ãƒŸãƒƒã‚¯ï¼ˆä»•æ›ã‘ã€å°å°ã€è£…ç½®ã€ãƒˆãƒ©ãƒƒãƒ—ãªã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®éšœå®³ã€‚noteã«ã¯ãã®è§£é™¤æ–¹æ³•ã‚‚å¿…ãšè¿½è¨˜ã™ã‚‹ï¼‰
    ãƒ»ãã®ä»–ï¼ˆä¸Šè¨˜ã«å½“ã¦ã¯ã¾ã‚‰ãªã„ãŒè¨˜éŒ²ã™ã¹ãã‚‚ã®ï¼‰
- note: è¦ç´ ã®è©³ç´°èª¬æ˜ã€‚100æ–‡å­—ä»¥ä¸ŠãŒæœ›ã¾ã—ã„ã€‚

### ä¾‹ï¼š
æ‘ã®é•·è€ãŒã€Œã“ã®æ‘ã¯æ•°ç™¾å¹´å‰ã€é­”å¥³ã®ä¸€æ—ã«ã‚ˆã£ã¦å»ºã¦ã‚‰ã‚ŒãŸã€ã¨èªã£ãŸã€‚
â†’ [command:add_history("æ‘ã®èµ·æº", "ã“ã®æ‘ã¯é­”å¥³ã®ä¸€æ—ã«ã‚ˆã£ã¦å»ºã¦ã‚‰ã‚ŒãŸã€‚")]

æ–°ãŸã«ã€Œãƒ«ã‚·ã‚¢ã€ã¨ã„ã†å¥³æ€§å¸ç¥­ãŒç™»å ´ã—ãŸã€‚
â†’ [command:create_canon("ãƒ«ã‚·ã‚¢", "NPC", "è‹¥ãã—ã¦å¤§ç¥æ®¿ã®ç¥­å¸ã‚’å‹™ã‚ã‚‹å¥³æ€§ã€‚éŠ€è‰²ã®é«ªã¨æ·¡ã„é’ã®ç³ã‚’æŒã¡ã€ç©ã‚„ã‹ãªå£èª¿ã§è©±ã™ã€‚æ‘äººã‹ã‚‰åšãä¿¡é ¼ã•ã‚Œã¦ã„ã‚‹ãŒã€éå»ã«ä¸€åº¦ã ã‘è¬ã®å¤±è¸ªã‚’çµŒé¨“ã—ã¦ãŠã‚Šã€ãã®é–“ã®è¨˜æ†¶ã¯å¤±ã‚ã‚Œã¦ã„ã‚‹ã€‚")]
"""


}


INTENT_SNIPPETS_MAP = {
    "info_request": ["action_check","item_control","canon_update"],
    "action": ["action_check","combat","end_section","item_control","canon_update"],
    "talk": ["action_check","combat","end_section","item_control","canon_update"],
    "gm_query": ["action_check","combat","end_section","item_control","canon_update"],
    "other": ["action_check","combat","end_section","item_control","canon_update"],
}

INTENT_MODEL_CONFIG = {
    "action": {"model_level": "high", "max_tokens": 30000},
    "talk": {"model_level": "high", "max_tokens": 20000},
    "info_request": {"model_level": "high", "max_tokens": 20000},
    "gm_query": {"model_level": "high", "max_tokens": 20000},
    "system": {"model_level": "medium", "max_tokens": 20000},
    "other": {"model_level": "high", "max_tokens": 20000}
}


class IntentHandler:
    def __init__(self, ctx, state, flags, convlog):
        self.ctx = ctx
        self.state = state
        self.flags = flags
        self.convlog = convlog

    def handle(self, label: str, player_input: str) -> str:
        if label == "chapter_intro":
            return self._handle_intro("chapter")
        elif label == "section_intro":
            return self._handle_intro("section")
            
        elif label == "post_check_description":
            return self._handle_post_check_description()
        
        elif label == "post_combat_description":
            return self._handle_post_combat_description()

        #elif self.state.scene == "transition":
        #    return self._handle_transition(label, player_input)

        elif self.state.scene == "exploration":
            return self._handle_exploration(label, player_input)
        
        elif self.state.scene != "exploration":
            print(f"[WARN] Scene '{self.state.scene}' ã¯ exploration ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ")
            return self._handle_exploration(label, player_input)
        
        else:
            raise NotImplementedError(f"Scene type '{self.scene}' ã¯æœªå®Ÿè£…ã§ã™")
            
    def _handle_intro(self, kind: str) -> str:
        wid = self.state.worldview_id 
        sid = self.state.session_id   
        chapter = self.state.chapter
        section = self.state.section
        section_idx = section - 1

        # plan.jsonï¼ˆå°å…¥æ–‡ï¼‰ã¨ scenario.jsonï¼ˆç« æ¦‚è¦ï¼‰ã‚’èª­ã‚€
        plan_path = get_data_path(f"worlds/{wid}/sessions/{sid}/chapters/chapter_{chapter:02}/plan.json")
        scenario_path = get_data_path(f"worlds/{wid}/sessions/{sid}/scenario.json")

        intro = ""
        overview = ""

        if plan_path.exists():
            with open(plan_path, encoding="utf-8") as f:
                plan = json.load(f)
            flow = plan.get("flow", [])
            if 0 <= section_idx < len(flow):
                intro = flow[section_idx].get("intro", "")

        if scenario_path.exists():
            with open(scenario_path, encoding="utf-8") as f:
                scenario = json.load(f)
            if 0 < chapter <= len(scenario.get("chapters", [])):
                overview = scenario["chapters"][chapter - 1].get("overview", "")

        # å°å…¥ç”¨å‘½ä»¤æ–‡ï¼ˆsystem prompt ã®å†’é ­ï¼‰
        if kind == "chapter":
            if chapter == 1:
                instruction = (
                    "ã‚ãªãŸã¯TRPGã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚\n"
                    "ã“ã‚Œã¯ç‰©èªã®ç¬¬ä¸€ç« ã®å°å…¥ã§ã™ã€‚ç‰©èªã®å§‹ã¾ã‚Šã¨ã—ã¦ã€èˆå°ã‚„èƒŒæ™¯ã€PCãŒã“ã®ç‰©èªã«é–¢ã‚ã‚‹ãã£ã‹ã‘ã‚’"
                    "è‡¨å ´æ„Ÿã‚ã‚‹å°å…¥ã§æå†™ã—ã¦ãã ã•ã„ã€‚èª­è€…ãŒç‰©èªä¸–ç•Œã«å¼•ãè¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«ã€æƒ…æ™¯ãƒ»ç©ºæ°—æ„Ÿãƒ»ç·Šå¼µæ„Ÿã‚’ãƒ©ãƒãƒ™é¢¨ã«æã„ã¦ãã ã•ã„ã€‚\n"
                    "å…¨æ–‡ã§1000å­—ç¨‹åº¦ã§ã€æœ€å¾Œã«PCãŒä½•ã‚’ã™ã‚‹ã‹é¸ã¹ã‚‹ã‚ˆã†ãªç›´å¾Œã®è¡Œå‹•æ¡ˆã‚’ã€Œè¡Œå‹•æ¡ˆï¼š1) ï½ 2) ï½ã€ã®å½¢å¼ã§2ï½3å€‹æç¤ºã—ã¦ãã ã•ã„ã€‚1ã¤ã®è¡Œå‹•æ¡ˆã”ã¨ã«æ”¹è¡Œã—ã€ç•ªå·ã”ã¨ã«åˆ¥è¡Œã«ã—ã¦ãã ã•ã„ã€‚\n"
                    "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç¤ºã™ã‚‹æ–‡ç« ã¯ã€**ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã‚ã¾ã‚Šå›ºæœ‰åè©ã‚’ä½¿ã‚ãšï¼ˆä½¿ã†ã¨ãã¯ååˆ†èª¬æ˜ä»˜ãã§ï¼‰**ã€ãƒ©ãƒãƒ™é¢¨ã®ä¸‰äººç§°ãƒ»åœ°ã®æ–‡ã§å¸¸ä½“ã«ã—ã¦ãã ã•ã„ã€‚æå†™ã¯ã‹ã£ã“ã¤ã‘ãšã€ã‚ã‹ã‚Šã‚„ã™ã•ã‚’å„ªå…ˆã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚\n"
                    "åŸºæœ¬çš„ã«ã€ã¾ãšã¯PCã®æ—¥å¸¸ã®æå†™ã‚’è¡Œã„ã€æ¬¡ã«ã‚·ãƒŠãƒªã‚ªã€ç« ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç›®çš„ã®ã†ã¡ã€ä¸€ç•ªè‡ªç„¶ã«å‘ã‹ã†ã“ã¨ã®ã§ãã‚‹ç›®çš„ã¸é€²ã‚€ã“ã¨ã«ãªã‚‹ãã£ã‹ã‘ã‚’æå†™ã—ã€è¡Œå‹•æ¡ˆã§èª˜å°ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"
                )
            else:
                instruction = (
                    "ã‚ãªãŸã¯TRPGã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚\n"
                    "ä»¥ä¸‹ã®æƒ…å ±ã¨ä¼šè©±å±¥æ­´ã‚’å‚è€ƒã«ã€æ–°ãŸã«å§‹ã¾ã‚‹ç« ã®å°å…¥æå†™ã‚’500å­—ç¨‹åº¦ã§æç¤ºã—ã¦ãã ã•ã„ã€‚\n"
                    "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒä»Šç¾åœ¨ã©ã“ã«ã„ã¦ã©ã®ã‚ˆã†ãªçŠ¶æ³ãªã®ã‹ã‚’ã€å…·ä½“çš„ã«æå†™ã—ã¦ãã ã•ã„ã€‚\n"
                    "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã“ã‚Œã‹ã‚‰ä½•ã‚’ã™ã‚Œã°è‰¯ã„ã®ã‹ãŒè‡ªç„¶ã¨ã‚ã‹ã‚‹ã‚ˆã†ã«ã€å…·ä½“çš„ãªèƒŒæ™¯ã¨ã€ç›´å¾Œã®è¡Œå‹•æ¡ˆã‚’ã€Œè¡Œå‹•æ¡ˆï¼š1) ï½ 2) ï½ã€ã®å½¢å¼ã§2ï½3å€‹æç¤ºã—ã¦ãã ã•ã„ã€‚1ã¤ã®è¡Œå‹•æ¡ˆã”ã¨ã«æ”¹è¡Œã—ã€ç•ªå·ã”ã¨ã«åˆ¥è¡Œã«ã—ã¦ãã ã•ã„ã€‚\n"
                    "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç¤ºã™ã‚‹æ–‡ç« ã¯ã€**ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã‚ã¾ã‚Šå›ºæœ‰åè©ã‚’ä½¿ã‚ãšï¼ˆä½¿ã†ã¨ãã¯ååˆ†èª¬æ˜ä»˜ãã§ï¼‰**ã€ãƒ©ãƒãƒ™é¢¨ã®ä¸‰äººç§°ãƒ»åœ°ã®æ–‡ã§å¸¸ä½“ã«ã—ã¦ãã ã•ã„ã€‚æå†™ã¯ã‹ã£ã“ã¤ã‘ãšã€ã‚ã‹ã‚Šã‚„ã™ã•ã‚’å„ªå…ˆã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
                )
        elif kind == "section":
            instruction = (
                "ã‚ãªãŸã¯TRPGã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚\n"
                "ä»¥ä¸‹ã®æƒ…å ±ã¨ä¼šè©±å±¥æ­´ã‚’å‚è€ƒã«ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å°å…¥æå†™ã‚’300å­—ç¨‹åº¦ã§æç¤ºã—ã¦ãã ã•ã„ã€‚\n"
                "ç›´å‰ã®æå†™ã¨è‡ªç„¶ã«ã¤ãªãŒã‚‹ã‚ˆã†ã«ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒä»Šç¾åœ¨ã©ã“ã«ã„ã¦ã©ã®ã‚ˆã†ãªçŠ¶æ³ãªã®ã‹ã‚’ã€å…·ä½“çš„ã«æå†™ã—ã¦ãã ã•ã„ã€‚\\n"
                "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã“ã‚Œã‹ã‚‰ä½•ã‚’ã™ã‚Œã°è‰¯ã„ã®ã‹ãŒè‡ªç„¶ã¨ã‚ã‹ã‚‹ã‚ˆã†ã«ã€å…·ä½“çš„ãªèƒŒæ™¯ã¨ã€ç›´å¾Œã®è¡Œå‹•æ¡ˆã‚’ã€Œè¡Œå‹•æ¡ˆï¼š1) ï½ 2) ï½ã€ã®å½¢å¼ã§2ï½3å€‹æç¤ºã—ã¦ãã ã•ã„ã€‚1ã¤ã®è¡Œå‹•æ¡ˆã”ã¨ã«æ”¹è¡Œã—ã€ç•ªå·ã”ã¨ã«åˆ¥è¡Œã«ã—ã¦ãã ã•ã„ã€‚\n"
                "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç¤ºã™ã‚‹æ–‡ç« ã¯ã€**ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã‚ã¾ã‚Šå›ºæœ‰åè©ã‚’ä½¿ã‚ãšï¼ˆä½¿ã†ã¨ãã¯ååˆ†èª¬æ˜ä»˜ãã§ï¼‰**ã€ãƒ©ãƒãƒ™é¢¨ã®ä¸‰äººç§°ãƒ»åœ°ã®æ–‡ã§å¸¸ä½“ã«ã—ã¦ãã ã•ã„ã€‚æå†™ã¯ã‹ã£ã“ã¤ã‘ãšã€ã‚ã‹ã‚Šã‚„ã™ã•ã‚’å„ªå…ˆã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
            )

        if overview:
            instruction += f"\n\nã“ã®ç« ã®æ¦‚è¦: {overview}"
        if intro:
            instruction += f"\nã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å°å…¥æƒ…å ±ï¼ˆå¿…ãšå‚è€ƒã«ã—ã¦ãã ã•ã„ï¼‰: {intro}"

        pre_keys = ["scenario","worldview", "character", "nouns", "canon", "plan"]
        for key in pre_keys:
            snippet = self._render_pre_snippet(key)
            if snippet.strip():
                instruction += "\n\n" + snippet

        # ä¼šè©±å±¥æ­´è¾¼ã¿ã§AIã¸é€ä¿¡
        messages = [{"role": "system", "content": instruction}]
        messages += self.convlog.get_slim()

        # ğŸ”½ ã“ã“ã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´
        if kind == "chapter":
            model_level = "Very_high"
        else:
            model_level = "high"

        response = self.ctx.engine.chat(
            messages=messages,
            caller_name=f"IntentHandler:{kind}_intro",
            model_level=model_level,
            max_tokens=20000
        )

        self.convlog.append("system", response)
        return response


    def _handle_exploration(self, label: str, player_input: str) -> str:
        base = INTENT_PROMPTS.get(label, INTENT_PROMPTS["other"])
        pre_keys = PRE_SNIPPET_KEYS_MAP.get(label, [])
        pre_extra = "\n\n".join(self._render_pre_snippet(k) for k in pre_keys)

        snippets = INTENT_SNIPPETS_MAP.get(label, [])
        extra = "\n\n".join(PROMPT_SNIPPETS[key] for key in snippets)
        # ã“ã“ã‹ã‚‰è¿½åŠ 
        wid = self.state.worldview_id
        sid = self.state.session_id
        chapter = self.state.chapter
        section_idx = self.state.section - 1

        scenario_path = get_data_path(
            f"worlds/{wid}/sessions/{sid}/scenario.json"
        )
        plan_path = get_data_path(
            f"worlds/{wid}/sessions/{sid}/chapters/chapter_{chapter:02}/plan.json"
        )

        is_final_chapter = False
        is_latter_half = False

        if scenario_path.exists():
            with open(scenario_path, encoding="utf-8") as f:
                scenario = json.load(f)
            chapters = scenario.get("draft", {}).get("chapters", [])
            if 0 < chapter <= len(chapters):
                is_final_chapter = (chapter == len(chapters))

        if plan_path.exists():
            with open(plan_path, encoding="utf-8") as f:
                plan = json.load(f)
            flow = plan.get("flow", [])
            if section_idx >= len(flow) // 2:
                is_latter_half = True

        goal_text = ""
        if plan_path.exists():
            with open(plan_path, encoding="utf-8") as f:
                plan = json.load(f)
            flow = plan.get("flow", [])
            current = flow[section_idx] if 0 <= section_idx < len(flow) else {}
            goal_text = current.get("goal", "")

        system_prompt = COMMON_PROMPT
        if pre_extra:
            system_prompt += "\n\n" + pre_extra
        system_prompt += "\n\n" + base
        if extra:
            system_prompt += "\n\n" + extra

        # æœ€çµ‚ç« ã‹ã¤å¾ŒåŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ãªã‚‰è¿½è¨˜
        if is_final_chapter and is_latter_half:
            system_prompt += (
                "\n\nã€ç‰¹è¨˜äº‹é …ã€‘ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ç‰©èªã®æœ€çµ‚ç« ã®å¾ŒåŠéƒ¨åˆ†ã§ã™ã€‚"
                "ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹æ„Ÿã‚„çµæœ«ã¸ã®ç››ã‚Šä¸ŠãŒã‚Šã‚’æ„è­˜ã—ã¦æå†™ã—ã¦ãã ã•ã„ã€‚"
            )

        messages = [{"role": "system", "content": system_prompt}]
        messages += self.convlog.get_slim()
        if label == "action" and goal_text:  
            goal_instruction = (
                f"\nã€ã‚·ã‚¹ãƒ†ãƒ ã€‘ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç›®çš„: {goal_text}\n"
                "â€»ã“ã®ç›®çš„ã‚’ã™ã¹ã¦æº€ãŸã—ãŸå ´åˆã€è©±ã«ä¸€æ—¦ã®åŒºåˆ‡ã‚Šã‚’ã¤ã‘ã¤ã¤å‡ºåŠ›ã®æœ€å¾Œã«å¿…ãš[end_section]ã‚’å˜ç‹¬ã®è¡Œã§æ›¸ãã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€²ã‚“ã§ãã ã•ã„ã€‚\n"
                "â€»ã“ã®ã¨ãã€è¡Œç‚ºåˆ¤å®š[action_check]ã‚„æˆ¦é—˜åˆ¤å®š[combat_start]ã€è¡Œå‹•æ¡ˆã®æç¤ºã‚’**çµ¶å¯¾ã«ã—ãªã„ã§ãã ã•ã„**ã€‚\n"
                "â€»ä¸€ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒçŸ­ããªã‚Šã™ããªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚\n"
                "â€»æœªé”æˆã®å ´åˆã¯[end_section]ã‚’æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚"
            )
            messages.append({"role": "user", "content": player_input.strip() + goal_instruction})
        else:
            messages.append({"role": "user", "content": player_input.strip()})



        config = INTENT_MODEL_CONFIG.get(label, {"model_level": "medium", "max_tokens": 3000})

        response = self.ctx.engine.chat(
            messages=messages,
            caller_name=f"IntentHandler:{label}",
            model_level=config["model_level"],
            max_tokens=config["max_tokens"]
        )

        self.convlog.append("user", player_input)
        self.convlog.append("system", response)

        return response

    def _render_pre_snippet(self, key: str) -> str:
        wid = self.state.worldview_id
        sid = self.state.session_id
        chapter = self.state.chapter

        if key == "scenario":

            scenario_path = get_data_path(f"worlds/{wid}/sessions/{sid}/scenario.json")
            theme = tone = style = "ï¼ˆæœªè¨­å®šï¼‰"
            if scenario_path.exists():
                with open(scenario_path, "r", encoding="utf-8") as f:
                    data = json.load(f)
                meta = data.get("meta", {})
                theme = meta.get("theme", theme)
                tone = meta.get("tone", tone)
                style = meta.get("style", style)

            return PRE_PROMPT_SNIPPETS["scenario"].format(
                theme=theme,
                tone=tone,
                style=style
            )

        elif key == "worldview":
            worldview = self.ctx.worldview_mgr.get_entry_by_id(wid) or {}
            long_desc = worldview.get("long_description") or worldview.get("description", "")
            tone = worldview.get("tone", "")
            genre = worldview.get("genre", "")
            
            # è¿½åŠ æƒ…å ±çµ„ã¿ç«‹ã¦
            extra_info = []
            if genre:
                extra_info.append(f"ã‚¸ãƒ£ãƒ³ãƒ«: {genre}")
            if tone:
                extra_info.append(f"ãƒˆãƒ¼ãƒ³: {tone}")
            
            # PRE_PROMPT_SNIPPETS ã«æ¸¡ã™æ–‡ç« 
            full_desc = long_desc.strip()
            if extra_info:
                full_desc += "\n" + " / ".join(extra_info)

            return PRE_PROMPT_SNIPPETS["worldview"].format(worldview=full_desc)


        elif key == "character":
            session = self.ctx.session_mgr.get_entry_by_id(sid)
            pcid = session.get("player_character")
            self.ctx.character_mgr.set_worldview_id(wid)
            char = self.ctx.character_mgr.load_character_file(pcid)
            name = char.get("name", "ï¼Ÿï¼Ÿï¼Ÿ")
            level = char.get("level", "?")
            background = char.get("background", "ä¸æ˜")
            items = char.get("items", [])
            checks = char.get("checks", {})

            text = f"{name}ï¼ˆãƒ¬ãƒ™ãƒ«{level}ï¼‰\nèƒŒæ™¯ï¼ˆã‚ãã¾ã§å‚è€ƒã«ã€€é€²è¡Œã®æµã‚Œã¯ã‚·ãƒŠãƒªã‚ªè¨­å®šå„ªå…ˆã§ï¼‰ï¼š{background}"

            if items:
                item_lines = []
                for item in items:
                    if isinstance(item, str):
                        # æ—§ä»•æ§˜: å˜ä¸€æ–‡å­—åˆ—
                        item_lines.append(f"- {item}")
                    elif isinstance(item, dict):
                        # æ–°ä»•æ§˜: {name, count, description}
                        iname = item.get("name", "")
                        count = item.get("count", 0)
                        desc = item.get("description", "")
                        if desc:
                            item_lines.append(f"- {iname} Ã—{count}ï¼š{desc}")
                        else:
                            item_lines.append(f"- {iname} Ã—{count}")
                text += "\næ‰€æŒã‚¢ã‚¤ãƒ†ãƒ :\n" + "\n".join(item_lines)

            if checks:
                skill_lines = [f"- {k}ï¼š+{v}" for k, v in checks.items()]
                text += "\nã‚¹ã‚­ãƒ«:\n" + "\n".join(skill_lines)

            return PRE_PROMPT_SNIPPETS["character"].format(character=text.strip())

        
        elif key == "nouns":
            self.ctx.nouns_mgr.set_worldview_id(wid)
            nouns = self.ctx.nouns_mgr.entries
            noun_lines = [
                f"- {n.get('name', '')}ï¼ˆ{n.get('type', '')}ï¼‰ï¼š{n.get('notes', '')}"
                for n in nouns
            ]
            return PRE_PROMPT_SNIPPETS["nouns"].format(nouns="\n".join(noun_lines))


        elif key == "canon":
            # ç½®ãæ›ãˆå¾Œå®Ÿè£…
            self.ctx.canon_mgr.set_context(wid, sid)
            canon = self.ctx.canon_mgr.list_entries() if hasattr(self.ctx.canon_mgr, "list_entries") else self.ctx.canon_mgr.entries

            lines = []
            for entry in canon:
                name = entry.get("name", "")
                typ = entry.get("type", "")
                notes = entry.get("notes", "")
                line = f"- {name}ï¼ˆ{typ}ï¼‰"
                if notes:
                    line += f"ï¼š{notes}"
                lines.append(line)

                history = entry.get("history", [])
                if history:
                    lines.append("  å±¥æ­´:")
                    for h in history:
                        ch = h.get("chapter", "?")
                        text = h.get("text", "")
                        label = "åˆæœŸè¨­å®š" if (isinstance(ch, int) and ch == 0) else f"ç¬¬{ch}ç« "
                        lines.append(f"    - {label}: {text}")

            lines.append("")
            return PRE_PROMPT_SNIPPETS["canon"].format(canon="\n".join(lines))


        elif key == "plan":
            plan_path = get_data_path(
                f"worlds/{wid}/sessions/{sid}/chapters/chapter_{chapter:02}/plan.json"
            )
            scenario_path = get_data_path(
                f"worlds/{wid}/sessions/{sid}/scenario.json"
            )

            # --- scenario.json èª­ã¿è¾¼ã¿ ---
            scenario_goal = ""
            chapter_goal = ""
            overviews = []
            if scenario_path.exists():
                with open(scenario_path, encoding="utf-8") as f:
                    scenario = json.load(f)

                draft = scenario.get("draft", {})
                scenario_goal = draft.get("goal", "").strip()
                overviews = draft.get("chapters", [])

                if 0 <= (chapter - 1) < len(overviews):
                    chapter_goal = overviews[chapter - 1].get("goal", "").strip()

            # --- plan.json èª­ã¿è¾¼ã¿ ---
            if plan_path.exists():
                with open(plan_path, encoding="utf-8") as f:
                    plan = json.load(f)
            else:
                plan = {}

            title = plan.get("title", "")
            flow = plan.get("flow", [])

            section_idx = self.state.section - 1

            # flowå…¨ä½“ã‚’ä¸€è¦§åŒ–ï¼ˆç¾åœ¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ˜ç¤ºï¼‰
            flow_lines = []
            for i, sec in enumerate(flow, 1):
                goal = sec.get("goal", "")
                desc = sec.get("description", "").strip()
                combat_flag = "æˆ¦é—˜ã®å¯èƒ½æ€§ã‚ã‚Š" if sec.get("has_combat") else "æˆ¦é—˜ã®å¯èƒ½æ€§ãªã—"

                if i - 1 == section_idx:
                    flow_lines.append(f"â–¶ ç¬¬{i}ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - ã€é‡è¦ï¼ï¼ã€‘ç›®çš„: {goal}")
                else:
                    flow_lines.append(f"  ç¬¬{i}ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - ç›®çš„: {goal}")

                if desc:
                    flow_lines.append(f"    èª¬æ˜: {desc}")
                flow_lines.append(f"    {combat_flag}")

            # è¡¨ç¤ºçµ„ã¿ç«‹ã¦
            lines = []
            if scenario_goal:
                lines.append(f"ã€ã‚·ãƒŠãƒªã‚ªå…¨ä½“ã®ç›®çš„ã€‘{scenario_goal}")
            if title:
                lines.append(f"ç« ã‚¿ã‚¤ãƒˆãƒ«: {title}")
            if chapter_goal:
                lines.append(f"ã€ã“ã®ç« ã®ç›®çš„ã€‘{chapter_goal}")
            lines.append("ã“ã®ç« ã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ§‹æˆï¼ˆâ–¶ã¯ç¾åœ¨ä½ç½®ï¼‰:")
            lines.extend(flow_lines)

            # æ¬¡ã®ç«  or æœ€çµ‚ç« ã®æƒ…å ±
            if chapter < len(overviews):
                next_chap = overviews[chapter]  # æ¬¡ç« ã¯listä¸Šã¯chapter indexï¼ˆ0åŸºæº–ï¼‰
                next_overview = next_chap.get("overview", "").strip()
                if next_overview:
                    lines.append(f"æ¬¡ã®ç« ã®å±•é–‹äºˆå‘Š: {next_overview}")
            else:
                lines.append("ã“ã®ç« ãŒæœ€çµ‚ç« ã§ã™ã€‚ã“ã“ã§ç‰©èªã¯çµ‚ã‚ã‚Šã¾ã™ã€‚")

            return PRE_PROMPT_SNIPPETS["plan"].format(plan="\n".join(lines))




        return ""

    def _handle_post_check_description(self) -> str:
        system_prompt = """
ã‚ãªãŸã¯ã‚½ãƒ­TRPGã®é€²è¡Œå½¹ï¼ˆGMï¼‰ã‚’å‹™ã‚ã‚‹AIã§ã™ã€‚
PCãŒç›´å‰ã«è¡Œã£ãŸè¡Œç‚ºåˆ¤å®šã®çµæœã‚’è¸ã¾ãˆã€ç‰¹ã«PCã®ç½®ã‹ã‚Œã¦ã„ã‚‹çŠ¶æ³ã®æ˜è¨˜ã«æ°—ã‚’ã¤ã‘ã€
ãã®è¡Œå‹•ãŒç‰©èªã«ã©ã®ã‚ˆã†ãªå½±éŸ¿ã‚’ä¸ãˆã€ã©ã®ã‚ˆã†ã«ã‚·ãƒŠãƒªã‚ªãŒé€²è¡Œã—ãŸã‹ã‚’ã€
ãŠãŠã‚ˆã300å­—ç¨‹åº¦ã§ã€é›°å›²æ°—ã‚ˆã‚Šã‚ã‹ã‚Šã‚„ã™ã•å„ªå…ˆã§ã€ãƒ©ã‚¤ãƒˆãƒãƒ™ãƒ«ã«ä½¿ã‚ã‚Œã‚‹ç¨‹åº¦ã®ç°¡å˜ãªèªå½™ã§æå†™ã—ã¦ãã ã•ã„ã€‚
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç¤ºã™ã‚‹æ–‡ç« ã¯ã€ä¸‰äººç§°ãƒ»åœ°ã®æ–‡ã§å¸¸ä½“ã«ã—ã¦ãã ã•ã„ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›ã‹ã‚‰åˆ¤å®šçµæœã‚’å—ã‘å–ã‚Šã€
ã€ãã®çµæœã«ã‚ˆã£ã¦èµ·ã“ã£ãŸå‡ºæ¥äº‹ã€ã‚„
ã€çŠ¶æ³ã®å¤‰åŒ–ã€ã€ç™»å ´äººç‰©ã®åå¿œã€ã€ç’°å¢ƒã®å¤‰åŒ–ã€ãªã©ã‚’ãã‚Œã‚‰ã—ãæå†™ã—ã¦ãã ã•ã„ã€‚
åˆ¤å®šã«æˆåŠŸã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚·ãƒŠãƒªã‚ªã‚’GMãƒ¡ãƒ¢ã«å¾“ã£ã¦**å¤§ãã**é€²è¡Œã•ã›ã¦ãã ã•ã„ã€‚
åˆ¤å®šã«å¤±æ•—ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãã‚ŒãŒå¿…é ˆã§ã‚ã‚‹ãªã‚‰ãƒªã‚«ãƒãƒªã‚’è¦æ±‚ã™ã‚‹æå†™ã¨ã—ã€å¿…é ˆã§ãªã„ãªã‚‰ãã®æ©Ÿä¼šã‚’å¤±ã£ãŸæå†™ã¨ã—ã¦ãã ã•ã„ã€‚
è¡Œç‚ºåˆ¤å®šã«ã¯å‡ºç›®ã‚„è£œæ­£å€¤ã«å¿œã˜ãŸçµæœã®â€œè³ªâ€ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®åˆ†é¡ã«åŸºã¥ã„ã¦ã€æå†™ã®ãƒˆãƒ¼ãƒ³ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ï¼š
- ã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€‘ï¼ˆå‡ºç›®12ï¼‰ï¼šåŠ‡çš„ã«æœ‰åˆ©ãªå±•é–‹ã‚„å¹¸é‹ãªçŠ¶æ³ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚ç›´æ¥é–¢ã‚ã‚Šã®ãªã„ãã®å¾Œã®å±•é–‹ã‚‚æœ‰åˆ©ã«ã—ã¦ãã ã•ã„ã€‚
- ã€ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ã€‘ï¼ˆå‡ºç›®2ï¼‰ï¼šäºˆæœŸã›ã¬ãƒˆãƒ©ãƒ–ãƒ«ã‚„å±æ©Ÿçš„ãªäº‹æ…‹ã€ã‚ã‚‹ã„ã¯æ˜ç¢ºãªå¤±ç­–ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚ç›´æ¥é–¢ã‚ã‚Šã®ãªã„ãã®å¾Œã®å±•é–‹ã‚‚ä¸åˆ©ã«ã—ã¦ãã ã•ã„ã€‚
- ã€æˆåŠŸï¼ˆã‚®ãƒªã‚®ãƒªï¼‰ã€‘ï¼šé”æˆå€¤ãŒç›®æ¨™å€¤ã¨åŒã˜ã‹1ã ã‘ä¸Šå›ã£ãŸå ´åˆã€æ…é‡ã•ã‚„ç·Šå¼µæ„Ÿã‚’åæ˜ ã—ã¦ãã ã•ã„ã€‚
- ã€æˆåŠŸï¼ˆä½™è£•ã‚ã‚Šï¼‰ã€‘ï¼šé”æˆå€¤ãŒç›®æ¨™å€¤ã‚’å¤§ããè¶…ãˆã¦ã„ãŸå ´åˆã€ä½™è£•ã®ã‚ã‚‹é®®ã‚„ã‹ãªæˆåŠŸã‚’æã„ã¦ãã ã•ã„ã€‚
- ã€å¤±æ•—ï¼ˆæƒœã—ã„ï¼‰ã€‘ï¼šç›®æ¨™å€¤ã«ã‚ã¨ä¸€æ­©å±Šã‹ãªã„å ´åˆã€æ‰‹å¿œãˆã¯ã‚ã£ãŸãŒå¤±æ•—ã—ãŸã¨ã„ã†å°è±¡ã‚’æã„ã¦ãã ã•ã„ã€‚
- ã€å®Œå…¨ãªå¤±æ•—ã€‘ï¼šå¤§ããç›®æ¨™ã«å±Šã‹ãªã‹ã£ãŸå ´åˆã¯ã€å¤±æ•—ã«ã‚ˆã‚‹å•é¡Œã‚„ä»Šå¾Œã®å›°é›£ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚
ãŸã ã—ã€ã“ã‚Œã‚‰ã®è³ªã®è¡¨ç¾ã¯æå†™ã®ã¿ã§è¡Œã„ã€é”æˆå€¤ã‚„ç›®æ¨™å€¤ã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ç­‰ã®**ãƒ¡ã‚¿ãªè¡¨ç¾**ã¯æ±ºã—ã¦ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

ã©ã®ã‚ˆã†ãªå½¢ã§ã‚‚æˆåŠŸã—ãŸãªã‚‰ã€**ã‚·ãƒŠãƒªã‚ªã‚’å¤§ããé€²è¡Œã•ã›ã¦ãã ã•ã„ã€‚** ç›®å®‰ã¨ã—ã¦ã¯ã€1ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¡Œç‚ºåˆ¤å®š3å›ã§ã™ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ç‰©èªã®é€”ä¸­ã§æ±ºã—ã¦æ­»äº¡ã—ã¾ã›ã‚“ã€‚
é‡å¤§ãªå¤±æ•—ã«ã‚ˆã£ã¦ç›®æ¨™ã‚’é”æˆã§ããªããªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ãŒã€é€”ä¸­ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæ­»ã¬å±•é–‹ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
ãŸã ã—ã‚·ãƒŠãƒªã‚ªã®çµæœ«ï¼ˆæœ€çµ‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã«ãŠã„ã¦ã®ã¿ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠã‚„ç‰©èªã®å¿…ç„¶æ€§ã«åŸºã¥ã„ã¦ã€
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæ­»äº¡ã™ã‚‹ã¨ã„ã†çµæœ«ã‚’æãã“ã¨ã¯è¨±å®¹ã•ã‚Œã¾ã™ã€‚

ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†æŒ‡é‡ã€‘
ã‚‚ã—ã“ã®ã“ã®è¡Œç‚ºåˆ¤å®šã®æˆåŠŸã«ã‚ˆã£ã¦ã€å¾Œè¿°ã™ã‚‹ã€Œç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç›®çš„ã€ã‚’é”æˆã—ãŸå ´åˆã¯ã€è©±ã«åŒºåˆ‡ã‚Šã‚’ã¤ã‘ã¤ã¤å‡ºåŠ›ã®æœ€å¾Œã«**å¿…ãš** `[end_section]` ã‚’å˜ç‹¬ã®è¡Œã§æ›¸ãã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ãã ã•ã„ã€‚
ã“ã®ã¨ãã€è¡Œå‹•æ¡ˆã®æç¤ºã¯**çµ¶å¯¾ã«ã—ãªã„ã§ãã ã•ã„**ã€‚ä»–ã®ã‚³ãƒãƒ³ãƒ‰ã¨åŒæ™‚ä½¿ç”¨å¯èƒ½ã§ã™

ã€ã‚¢ã‚¤ãƒ†ãƒ æ“ä½œã‚³ãƒãƒ³ãƒ‰ã€‘
ã“ã®è¡Œç‚ºåˆ¤å®šPCã®æ‰€æŒå“ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã€å‡ºåŠ›ã®æœ€å¾Œå°¾ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°åŒæ™‚å¯ï¼‰ï¼š
- è¿½åŠ : [command:add_item("ã‚¢ã‚¤ãƒ†ãƒ å", å€‹æ•°, "èª¬æ˜æ–‡")]
- å‰Šé™¤: [command:remove_item("ã‚¢ã‚¤ãƒ†ãƒ å", å€‹æ•°)]
èª¬æ˜æ–‡ã‚’å¤‰æ›´ã—ãªã„å ´åˆã¯ç©ºæ–‡å­— "" ã‚’æŒ‡å®šã€‚

ã€ã‚«ãƒãƒ³æ“ä½œã‚³ãƒãƒ³ãƒ‰ã€‘
ã“ã®è¡Œç‚ºåˆ¤å®šã«ã‚ˆã‚Šã€æ—¢å­˜ã®ã‚«ãƒãƒ³ã«æ–°ãŸãªäº‹å®Ÿã‚’è¿½åŠ ã—ãŸã‚Šã€æ–°ã—ã„ã‚«ãƒãƒ³ã‚’ä½œæˆã™ã‚‹å ´åˆã¯ã€
å‡ºåŠ›ã®æœ€å¾Œå°¾ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚è¤‡æ•°åŒæ™‚ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ï¼ˆè¤‡æ•°åŒæ™‚å¯ï¼‰ï¼š
æ—¢å­˜ã‚«ãƒãƒ³ã¸ã®è¿½åŠ : [command:add_history("ã‚«ãƒãƒ³å", "è¿½åŠ å†…å®¹")]
æ–°è¦ã‚«ãƒãƒ³ä½œæˆ: [command:create_canon("ã‚«ãƒãƒ³å", "ã‚¿ã‚¤ãƒ—", "è©³ç´°èª¬æ˜")]
ã‚¿ã‚¤ãƒ—ã¯ã€Œå ´æ‰€ã€ã€ŒNPCã€ã€ŒçŸ¥è­˜ã€ã€Œã‚¢ã‚¤ãƒ†ãƒ ã€ã€Œã‚®ãƒŸãƒƒã‚¯ã€ã€Œãã®ä»–ã€ã‹ã‚‰é¸æŠã€‚
"""

        # çŠ¶æ³æŠŠæ¡ç”¨ã® pre_snippet ã‚’ä»˜ä¸
        pre_keys = ["scenario","worldview", "character", "nouns", "canon", "plan"]
        pre_extra = "\n\n".join(self._render_pre_snippet(k) for k in pre_keys)
        if pre_extra:
            system_prompt += "\n\n" + pre_extra

        messages = [{"role": "system", "content": system_prompt}]
        messages += self.convlog.get_slim()

        response = self.ctx.engine.chat(
            messages=messages,
            caller_name="IntentHandler:post_check_description",
            model_level="high",
            max_tokens=20000,
        )

        self.convlog.append("system", response)
        return response


    def _handle_post_combat_description(self) -> str:
        system_prompt = """
ã‚ãªãŸã¯ã‚½ãƒ­TRPGã®é€²è¡Œå½¹ï¼ˆGMï¼‰ã‚’å‹™ã‚ã‚‹AIã§ã™ã€‚
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒç›´å‰ã«è¡Œã£ãŸæˆ¦é—˜åˆ¤å®šã®çµæœã‚’è¸ã¾ãˆã€ç‰¹ã«**PCã®ç½®ã‹ã‚Œã¦ã„ã‚‹çŠ¶æ³ã®æ˜è¨˜**ã«æ°—ã‚’ã¤ã‘ã€
ãã®æˆ¦é—˜è¡Œå‹•ãŒç‰©èªã«ã©ã®ã‚ˆã†ãªå½±éŸ¿ã‚’ä¸ãˆãŸã‹ã‚’ã€ãŠãŠã‚ˆã300å­—ç¨‹åº¦ã§ã€é›°å›²æ°—ã‚ˆã‚Šã‚ã‹ã‚Šã‚„ã™ã•å„ªå…ˆã§ã€
ãƒ©ã‚¤ãƒˆãƒãƒ™ãƒ«ã«ä½¿ã‚ã‚Œã‚‹ç¨‹åº¦ã®ç°¡å˜ãªèªå½™ã§æå†™ã—ã¦ãã ã•ã„ã€‚
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç¤ºã™ã‚‹æ–‡ç« ã¯ã€ä¸‰äººç§°ãƒ»åœ°ã®æ–‡ã§å¸¸ä½“ã«ã—ã¦ãã ã•ã„ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›ã‹ã‚‰åˆ¤å®šçµæœã‚’å—ã‘å–ã‚Šã€
ãƒ»ãã®æˆ¦æ³•ãŒæˆåŠŸã¾ãŸã¯å¤±æ•—ã—ãŸã“ã¨ã«ã‚ˆã‚‹æ•µã®åå¿œã‚„çŠ¶æ³ã®å¤‰åŒ–
ãƒ»æˆ¦æ³ã®æ¨ç§»ã‚„ç’°å¢ƒã®å¤‰åŒ–
ãƒ»ä»–ã®ç™»å ´äººç‰©ã®åå¿œ
ãªã©ã‚’ãã‚Œã‚‰ã—ãæå†™ã—ã¦ãã ã•ã„ã€‚

â€»ã“ã®æˆ¦é—˜åˆ¤å®šã¯ã€æœ€å¤§ã§2å›ã¾ã§ç¹°ã‚Šè¿”ã•ã‚Œã¾ã™ã€‚
åŸºæœ¬çš„ã«ã¯1å›ã§æˆ¦é—˜ãŒçµ‚äº†ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ãŒã€
ã‚·ãƒŠãƒªã‚ªã®æœ€çµ‚å±€é¢ãƒ»å¼·æ•µã¨ã®æˆ¦é—˜ãƒ»é”æˆå€¤ãŒå¾®å¦™ãªå ´åˆãªã©ã€
æˆ¦é—˜ã®ç¶™ç¶šãŒè‡ªç„¶ã§ã‚ã‚‹ã¨åˆ¤æ–­ã•ã‚Œã‚‹å ´åˆã¯ã€
æˆ¦å ´ã®æå†™ã‚„æ•µã®å‹•ãã‚’å«ã‚ã¦ã€æˆ¦é—˜ãŒç¶šã„ã¦ã„ã‚‹ã“ã¨ã‚’æ˜ç¢ºã«ç¤ºã—ã¦ãã ã•ã„ã€‚

æˆ¦é—˜ãŒçµ‚äº†ã—ãŸå ´åˆã¯ã€ãã®ä½™æ³¢ã‚„å‹åˆ©ãƒ»æ•—åŒ—ã®é›°å›²æ°—ã‚’æå†™ã—ã€
å¿…è¦ã«å¿œã˜ã¦ã‚·ãƒŠãƒªã‚ªã‚’é€²è¡Œã•ã›ã€
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã“ã‚Œã‹ã‚‰ä½•ã‚’ã™ã‚Œã°è‰¯ã„ã®ã‹ãŒè‡ªç„¶ã¨ã‚ã‹ã‚‹ã‚ˆã†ã€
å…·ä½“çš„ãªèƒŒæ™¯ã‚„æ¬¡ã®è¡Œå‹•ã®é¸æŠè‚¢ã¨ãªã‚‹ã‚ˆã†ãªæƒ…å ±ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚

â€»æˆ¦é—˜åˆ¤å®šã«ã¯æ˜ç¢ºãªã€Œç›®æ¨™å€¤ã€ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã€ŒæˆåŠŸã€ã¾ãŸã¯ã€Œå¤±æ•—ã€ã®åˆ¤å®šã¯AIã§åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
åˆ¤å®šã®çµæœï¼ˆå‡ºç›®ã‚„ãƒœãƒ¼ãƒŠã‚¹ã®åˆè¨ˆå€¤ï¼‰ã‚’å‚è€ƒã«ã—ã¦ã€æ¬¡ã®ã‚ˆã†ã«åˆ¤å®šã—ã¦ãã ã•ã„ï¼š
- é”æˆå€¤ãŒ12ä»¥ä¸Šï¼šåŸºæœ¬çš„ã«ã€ŒæˆåŠŸã€ã¨è¦‹ãªã—ã¦æ§‹ã„ã¾ã›ã‚“ã€‚
- é”æˆå€¤ãŒ8æœªæº€ï¼šåŸºæœ¬çš„ã«ã€Œå¤±æ•—ã€ã¨è¦‹ãªã—ã¦æ§‹ã„ã¾ã›ã‚“ã€‚
- 8ã€œ11ã®ç¯„å›²ï¼šæ•µã®å¼·ã•ã€çŠ¶æ³ã‚„æˆ¦æ³•ã®è³ªã«ã‚ˆã£ã¦æŸ”è»Ÿã«åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
- å‡ºç›®ãŒ12ï¼ˆ=6+6ï¼‰ã®å ´åˆã¯ã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€‘ï¼šç„¡æ¡ä»¶æˆåŠŸã€‚ãã®å¾Œã®å±•é–‹ã‚‚æœ‰åˆ©ã«ã€‚
- å‡ºç›®ãŒ2ï¼ˆ=1+1ï¼‰ã®å ´åˆã¯ã€ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ã€‘ï¼šåŸå‰‡å¤±æ•—ï¼ˆãŸã ã—æ•µãŒåœ§å€’çš„ã«å¼±ã„ãªã©ç‰¹ä¾‹æ™‚ã¯é™¤ãï¼‰ã€‚

æå†™ã®ãƒˆãƒ¼ãƒ³ã¯ã€ä»¥ä¸‹ã®åˆ¤å®šçµæœã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼š
- ã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€‘ï¼šé®®ã‚„ã‹ãªå‹åˆ©ã€æ•µã®å‹•æºã€ãƒ‰ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ãªå±•é–‹ãªã©ã€‚ãã®å¾Œã®å±•é–‹ã‚‚æœ‰åˆ©ã«ã€‚
- ã€ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ã€‘ï¼šé‡å¤§ãªãƒŸã‚¹ã€å±æ©Ÿçš„çŠ¶æ³ã€å¥‡å¦™ãªãƒˆãƒ©ãƒ–ãƒ«ãªã©ã€‚åŠ›é‡å·®ãŒãªã„é™ã‚ŠåŸºæœ¬ã¯æ•—åŒ—ã€‚
- ã€æˆåŠŸã€‘ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æˆ¦æ³•ãŒã†ã¾ãã„ã£ãŸã“ã¨ã‚’æå†™ã€‚
- ã€å¤±æ•—ã€‘ï¼šåŸå‰‡ã¨ã—ã¦æ•—åŒ—ã€‚ãŸã ã—ã€æˆ¦é—˜ç¶™ç¶šãŒè‡ªç„¶ãªå ´åˆã¯ãã®ä½™åœ°ã‚’æ®‹ã—ãŸæå†™ã‚‚å¯ã€‚
ã“ã‚Œã‚‰ã®è³ªã®è¡¨ç¾ã¯æå†™ã®ã¿ã§è¡Œã„ã€é”æˆå€¤ã‚„åˆ¤å®šçµæœã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ç­‰ã®**ãƒ¡ã‚¿ãªè¡¨ç¾**ã¯æ±ºã—ã¦ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ç‰©èªã®é€”ä¸­ã§çµ¶å¯¾ã«æ­»äº¡ã—ã¾ã›ã‚“ãŒã€
è² å‚·ã—ãŸã‚Šã€æˆ¦æ³ãŒä¸åˆ©ã«ãªã‚‹æå†™ã¯è¨±å®¹ã•ã‚Œã¾ã™ã€‚

ã¾ãŸã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã€ãƒ¬ãƒ™ãƒ«ã€ã«å¿œã˜ãŸåŠ›é‡å·®ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®åŸºæº–ã‚’å‚è€ƒã«ã€æ•µã¨ã®å®ŸåŠ›å·®ãŒå¤§ãã„å ´åˆã¯åˆ¤å®šçµæœã«é–¢ã‚ã‚‰ãšã€
æˆ¦é—˜ã®çµæœã‚„æå†™ã«é•å’Œæ„ŸãŒå‡ºãªã„ã‚ˆã†ã«èª¿æ•´ã—ã¦ãã ã•ã„ï¼š
0ï¼šä¸€èˆ¬äººï¼ˆéæˆ¦é—˜å“¡ï¼‰
1ã€œ3ï¼šåˆå¿ƒè€…ã€œè¦‹ç¿’ã„å†’é™ºè€…
4ã€œ6ï¼šç†Ÿç·´è€…ã‚¯ãƒ©ã‚¹ï¼ˆä¸€äººå‰ï¼‰
7ã€œ10ï¼šè¶…äººçš„ãªå­˜åœ¨
11ã€œ13ï¼šä¼èª¬ãƒ»ç¥è©±ç´šã®è‹±é›„
14ã€œ15ï¼šç¥ã‚„ç²¾éœŠã«åŒ¹æ•µã™ã‚‹å­˜åœ¨

ãŸã¨ãˆã°ã€ãƒ¬ãƒ™ãƒ«7ä»¥ä¸Šã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒç›¸æ‰‹ã«ã™ã‚‹ã®ãŒå˜ãªã‚‹ã‚´ãƒ­ãƒ„ã‚­ã§ã‚ã‚Œã°ã€
å‡ºç›®ãŒæ‚ªãã¦ã‚‚åœ§å€’çš„ã«åˆ¶åœ§ã™ã‚‹å±•é–‹ãŒè‡ªç„¶ã§ã™ã€‚
é€†ã«ã€ä½ãƒ¬ãƒ™ãƒ«ã®ã‚­ãƒ£ãƒ©ãŒå¼·æ•µã«æŒ‘ã‚€å ´åˆã¯ã€æˆåŠŸã—ãŸå ´åˆã¯ååˆ†ãªæ±ºå®šæ‰“ã‚’ä¸ãˆã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

ã€ã‚¢ã‚¤ãƒ†ãƒ æ“ä½œã‚³ãƒãƒ³ãƒ‰ã€‘
ã“ã®æˆ¦é—˜æå†™ã«ã‚ˆã‚ŠPCã®æ‰€æŒå“ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã€å‡ºåŠ›ã®æœ€å¾Œå°¾ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°åŒæ™‚å¯ï¼‰ï¼š
- è¿½åŠ : [command:add_item("ã‚¢ã‚¤ãƒ†ãƒ å", å€‹æ•°, "èª¬æ˜æ–‡")]
- å‰Šé™¤: [command:remove_item("ã‚¢ã‚¤ãƒ†ãƒ å", å€‹æ•°)]
èª¬æ˜æ–‡ã‚’å¤‰æ›´ã—ãªã„å ´åˆã¯ç©ºæ–‡å­— "" ã‚’æŒ‡å®šã€‚

ã€ã‚«ãƒãƒ³æ“ä½œã‚³ãƒãƒ³ãƒ‰ã€‘
ã“ã®æˆ¦é—˜æå†™ã«ã‚ˆã‚Šã€æ—¢å­˜ã®ã‚«ãƒãƒ³ã«æ–°ãŸãªäº‹å®Ÿã‚’è¿½åŠ ã—ãŸã‚Šã€æ–°ã—ã„ã‚«ãƒãƒ³ã‚’ä½œæˆã™ã‚‹å ´åˆã¯ã€
å‡ºåŠ›ã®æœ€å¾Œå°¾ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚è¤‡æ•°åŒæ™‚ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ï¼ˆè¤‡æ•°åŒæ™‚å¯ï¼‰ï¼š
æ—¢å­˜ã‚«ãƒãƒ³ã¸ã®è¿½åŠ : [command:add_history("ã‚«ãƒãƒ³å", "è¿½åŠ å†…å®¹")]
æ–°è¦ã‚«ãƒãƒ³ä½œæˆ: [command:create_canon("ã‚«ãƒãƒ³å", "ã‚¿ã‚¤ãƒ—", "è©³ç´°èª¬æ˜")]
ã‚¿ã‚¤ãƒ—ã¯ã€Œå ´æ‰€ã€ã€ŒNPCã€ã€ŒçŸ¥è­˜ã€ã€Œã‚¢ã‚¤ãƒ†ãƒ ã€ã€Œã‚®ãƒŸãƒƒã‚¯ã€ã€Œãã®ä»–ã€ã‹ã‚‰é¸æŠã€‚
"""
        pre_keys = ["scenario","worldview", "character", "nouns", "canon", "plan"]
        pre_extra = "\n\n".join(self._render_pre_snippet(k) for k in pre_keys)
        if pre_extra:
            system_prompt += "\n\n" + pre_extra

        messages = [{"role": "system", "content": system_prompt}]
        messages += self.convlog.get_slim()

        response = self.ctx.engine.chat(
            messages=messages,
            caller_name="IntentHandler:post_combat_description",
            model_level="high",
            max_tokens=20000,
        )

        self.convlog.append("system", response)
        return response
